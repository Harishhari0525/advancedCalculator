<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Advanced Calculator</title>
  <!-- Math.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.min.js"></script>
  <style>
    :root {
      /* Theme Variables */
      --bg: #f3f4f6;
      --fg: #111;
      --calc-bg: #fff;
      --panel-bg: #f9fafb;
      --panel-border: #ddd;
      --btn-grid: #e5e7eb;
      --btn-grid-hover: #d1d5db;
      --btn-history: #3b82f6;
      --btn-clear-history: #f97316;
      --btn-export: #10b981;
      --btn-clear: #ef4444;
      --btn-theme: #6366f1;
      --shadow: rgba(0,0,0,0.1);
    }
    [data-theme="dark"] {
      --bg: #111;
      --fg: #eee;
      --calc-bg: #1e1e1e;
      --panel-bg: #2c2c2c;
      --panel-border: #444;
      --btn-grid: #333;
      --btn-grid-hover: #444;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 1rem;
      background: var(--bg); color: var(--fg);
      font-family: 'Segoe UI', Tahoma, Verdana, sans-serif;
      display: flex; justify-content: center;
      touch-action: manipulation;
    }
    .container {
      display: grid;
      grid-template-columns: 1fr 300px;
      gap: 1rem;
      max-width: 900px;
      width: 100%;
      margin: auto;
    }
    .calculator {
      background: var(--calc-bg);
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 4px 12px var(--shadow);
      display: flex; flex-direction: column; gap: 1rem;
    }
    h3 { margin:0 0 .5rem; }
    .display, .result {
      background: var(--panel-bg);
      border:1px solid var(--panel-border);
      border-radius:8px;
      padding:1rem;
      font-family: monospace;
      text-align: right;
    }
    .display { font-size:1.5rem; }
    .result-label { margin:0; color:#6b7280; }
    .result { font-size:1.25rem; font-weight:bold; }
    .buttons {
      display:grid;
      grid-template-columns:repeat(4, minmax(0,1fr));
      gap:.5rem;
    }
    .btn {
      background: var(--btn-grid);
      border: none;
      border-radius: 8px;
      padding: 0.75rem 1rem;  /* reduced size */
      font-size: 1rem;
      color: var(--fg);
      cursor: pointer;
      transition: background 0.2s;
      white-space: nowrap;
    }
    .btn:hover { background: var(--btn-grid-hover); }
    .actions { display:flex; gap:.5rem; }
    .actions .btn {
      flex: 1;
      padding: 0.5rem;
      font-size: 1rem;
      white-space: nowrap;
    }
    .btn-history { background: var(--btn-history); color:#fff; }
    .btn-clear-history { background: var(--btn-clear-history); color:#fff; }
    .btn-export { background: var(--btn-export); color:#fff; }
    .btn-clear { background: var(--btn-clear); color:#fff; }
    .btn-theme { background: var(--btn-theme); color:#fff; }
    .history-panel {
      background: var(--calc-bg);
      border:1px solid var(--panel-border);
      border-radius:12px;
      box-shadow:0 4px 12px var(--shadow);
      display:none;
      flex-direction:column;
      overflow:hidden;
      align-self:start;
    }
    .history-panel.show { display:flex; }
    .history-panel h4 {
      margin:0; padding:1rem;
      background: var(--panel-bg);
      border-bottom:1px solid var(--panel-border);
    }
    .history-content { flex:1; padding:.5rem 1rem; overflow-y:auto; }
    .history-entry { padding:.25rem 0; border-bottom:1px solid var(--panel-border); font-size:.9rem; }
    @media (max-width:768px) {
      .container { grid-template-columns:1fr; }
      .history-panel { position:static; width:100%; margin-top:1rem; border-radius:8px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="calculator">
      <h3>Advanced Calculator</h3>
      <div id="display" class="display">0</div>
      <p class="result-label">Answer:</p>
      <div id="result" class="result"></div>
      <div class="buttons"></div>
      <div class="actions">
        <button class="btn btn-history toggle-history">History</button>
        <button class="btn btn-clear-history clear-history">Clear History</button>
        <button class="btn btn-export export-btn" data-format="txt">Export .txt</button>
        <button class="btn btn-export export-btn" data-format="csv">Export .csv</button>
        <button class="btn btn-theme theme-toggle">ðŸŒ“</button>
      </div>
    </div>
    <div id="history-panel" class="history-panel">
      <h4>History</h4>
      <div class="history-content"></div>
    </div>
  </div>
  <script>
    const debounce = (fn, d) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), d); }; };
    const root = document.documentElement;
    root.setAttribute('data-theme', localStorage.getItem('theme') || 'light');
    document.querySelector('.theme-toggle').addEventListener('click', () => {
      const next = root.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
      root.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
    });
    class Calculator {
      constructor() {
        this.display = document.getElementById('display');
        this.resultEl = document.getElementById('result');
        this.historyPanel = document.getElementById('history-panel');
        this.historyContent = document.querySelector('.history-content');
        this.expr = '';
        this.just = false;
        this.last = null;
        this.history = JSON.parse(localStorage.getItem('calcHistory') || '[]');
        this.saveHistory = debounce(h => localStorage.setItem('calcHistory', JSON.stringify(h)), 300);
        this.initButtons();
        this.renderHistory();
      }
      initButtons() {
        const btnContainer = document.querySelector('.buttons');
        const tokens = ['7','8','9','/','4','5','6','*','1','2','3','-','0','.','=','+','(',')','sqrt(','^','sin(','cos(','tan(','log10(','pi','e','abs(', 'Clear'];
        // place Clear after abs(
        tokens.splice(tokens.indexOf('Clear'), 1);
        tokens.push('Clear');
        tokens.forEach(tok => {
          const btn = document.createElement('button');
          btn.className = 'btn';
          btn.textContent = tok;
          if (tok === 'Clear') btn.addEventListener('click', () => this.clearAll());
          else if (tok === '=') btn.addEventListener('click', () => this.calculate());
          else btn.addEventListener('click', () => this.append(tok));
          btnContainer.appendChild(btn);
        });
        document.querySelector('.clear-history').addEventListener('click', () => this.clearHistory());
        document.querySelectorAll('.export-btn').forEach(b => b.addEventListener('click', () => this.exportHistory(b.dataset.format)));
        document.querySelector('.toggle-history').addEventListener('click', () => this.historyPanel.classList.toggle('show'));
        document.addEventListener('keydown', e => {
          if (/^[0-9+\-*/^()]$/.test(e.key)) this.append(e.key);
          else if (e.key === 'Enter') this.calculate();
          else if (e.key === 'Backspace') this.backspace();
          else if (e.key === 'Escape') this.clearAll();
        });
      }
      append(ch) {
        if (this.just && !/^[+\-*/^]$/.test(ch)) { this.expr = ''; this.just = false; }
        if (this.just && /^[+\-*/^]$/.test(ch)) { this.expr = this.last + ch; this.just = false; }
        else this.expr += ch;
        this.display.textContent = this.expr || '0';
      }
      clearAll() {
        this.expr = '';
        this.display.textContent = '0';
        this.resultEl.textContent = '';
        this.just = false;
        document.activeElement.blur();
      }
      backspace() {
        this.expr = this.expr.slice(0, -1);
        this.display.textContent = this.expr || '0';
      }
      calculate() {
        try {
          const r = math.evaluate(this.expr);
          this.last = r;
          this.resultEl.textContent = r;
          this.just = true;
          this.history.unshift(`${this.expr} = ${r}`);
          if (this.history.length > 50) this.history.pop();
          this.renderHistory();
        } catch {
          this.resultEl.textContent = 'Error';
        }
      }
      renderHistory() {
        this.historyContent.innerHTML = this.history.length
          ? this.history.map(h => `<div class="history-entry">${h}</div>`).join('')
          : '<p>No history.</p>';
        this.historyContent.scrollTop = this.historyContent.scrollHeight;
        this.saveHistory(this.history);
      }
      clearHistory() {
        this.history = [];
        this.renderHistory();
      }
      exportHistory(fmt) {
        if (!this.history.length) return alert('No history');
        const data = fmt === 'csv'
          ? `Expression,Result\n${this.history.map(h => h.replace(' = ', ',')).join('\n')}`
          : this.history.join('\n');
        const blob = new Blob([data], { type: 'text/plain' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `history.${fmt}`;
        a.click();
      }
    }
    window.onload = () => new Calculator();
  </script>
</body>
</html>
