<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Advanced Calculator</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.min.js"></script>
  <style>
    :root {
      --bg: #f3f4f6;
      --fg: #111;
      --calc-bg: #fff;
      --panel-bg: #f9fafb;
      --panel-border: #ddd;
      --btn-grid: #e5e7eb;
      --btn-grid-hover: #d1d5db;
      --btn-clear: #ef4444;
      --btn-history: #3b82f6;
      --btn-clear-history: #f97316;
      --btn-export: #10b981;
      --btn-theme: #6366f1;
      --btn-copy: #8b5cf6;
      --btn-mem: #facc15;
      --shadow: rgba(0,0,0,0.1);
    }
    [data-theme="dark"] {
      --bg: #111;
      --fg: #eee;
      --calc-bg: #1e1e1e;
      --panel-bg: #2c2c2c;
      --panel-border: #444;
      --btn-grid: #333;
      --btn-grid-hover: #444;
    }
    * { box-sizing: border-box; }
    html, body {
      margin: 0;
      padding: 1rem;
      background: var(--bg);
      color: var(--fg);
      font-family: 'Segoe UI', Tahoma, Verdana, sans-serif;
    }
    body { display: flex; justify-content: center; align-items: flex-start; }
    .container {
      display: grid;
      grid-template-columns: 1fr 300px;
      gap: 1rem;
      width: 100%;
      max-width: 900px;
      margin: auto;
    }
    .calculator {
      background: var(--calc-bg);
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 4px 12px var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    h3 { margin: 0 0 0.5rem; }
    .display {
      width: 100%;
      background: var(--panel-bg);
      border: 1px solid var(--panel-border);
      border-radius: 8px;
      padding: 1rem; /* no extra right padding */
      font-family: monospace;
      text-align: right;
      font-size: 1.5rem;
      min-height: 58px;
      word-wrap: break-word;
    }
    .result {
      width: 90%;
      background: var(--panel-bg);
      border: 1px solid var(--panel-border);
      border-radius: 8px;
      padding: 1rem 4rem 1rem 1rem; /* extra right padding for icon */
      font-family: monospace;
      text-align: left;
      font-size: 1.25rem;
      font-weight: bold;
      min-height: 52px;
      word-wrap: break-word;
    }
    .result-label { margin: 0; color: #6b7280; }
    .buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
      gap: 0.5rem;
    }
    .btn {
      background: var(--btn-grid);
      border: none;
      border-radius: 8px;
      padding: 0.75rem 1rem;
      font-size: 1rem;
      color: var(--fg);
      cursor: pointer;
      transition: background 0.2s;
      white-space: nowrap;
    }
    .btn:hover { background: var(--btn-grid-hover); }
    .btn-clear { background: var(--btn-clear); color: #fff; }
    .btn-history { background: var(--btn-history); color: #fff; }
    .btn-clear-history { background: var(--btn-clear-history); color: #fff; }
    .btn-export { background: var(--btn-export); color: #fff; }
    .btn-theme { background: var(--btn-theme); color: #fff; }
    .btn-copy { background: var(--btn-copy); color: #fff; }
    .btn-mem { background: var(--btn-mem); color: #000; }
    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .actions .btn {
      flex: 1 1 100px;
      padding: 0.75rem;
      font-size: 1rem;
    }
    .result-wrapper {
      position: relative;
      display: flex;
      align-items: center;
      width: 100%;
    }
    .copy-icon {
      position: absolute;
      right: 0.5rem;
      padding: 0.5rem;
      border-radius: 50%;
    }
    .graph-canvas {
      display: none;
      width: 100%;
      height: 200px;
      border: 1px solid var(--panel-border);
      margin-top: 1rem;
    }
    .history-panel {
      background: var(--calc-bg);
      border: 1px solid var(--panel-border);
      border-radius: 12px;
      box-shadow: 0 4px 12px var(--shadow);
      display: none;
      flex-direction: column;
      overflow: hidden;
      align-self: start;
      max-height: 100%;
    }
    .history-panel.show { display: flex; }
    .history-panel h4 {
      margin: 0;
      padding: 1rem;
      background: var(--panel-bg);
      border-bottom: 1px solid var(--panel-border);
    }
    .history-search {
      padding: 0.5rem 1rem;
      border: none;
      border-bottom: 1px solid var(--panel-border);
      outline: none;
      font-size: 1rem;
    }
    .history-content {
      flex: 1;
      padding: 0.5rem 1rem;
      overflow-y: auto;
    }
    .history-entry {
      padding: 0.25rem 0;
      border-bottom: 1px solid var(--panel-border);
      font-size: 0.9rem;
      cursor: pointer;
    }
    .history-entry:hover { background-color: var(--btn-grid-hover); }
    @media (max-width: 768px) {
      .container { grid-template-columns: 1fr; }
      .history-panel { position: static; width: 100%; margin-top: 1rem; border-radius: 8px; }
      .buttons { grid-template-columns: repeat(auto-fit, minmax(70px, 1fr)); }
      .actions .btn { flex: 1 1 80px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="calculator">
      <h3>Advanced Calculator</h3>
      <div id="display" class="display">0</div>
      <p class="result-label">Answer:</p>
      <div class="result-wrapper">
        <div id="result" class="result">0</div>
        <button class="btn btn-copy copy-icon" title="Copy result">ðŸ“‹</button>
      </div>
      <div class="buttons"></div>
      <div class="actions">
        <button class="btn btn-history toggle-history">History</button>
        <button class="btn btn-clear-history clear-history">Clear History</button>
        <button class="btn btn-export export-btn" data-format="txt">Export .txt</button>
        <button class="btn btn-export export-btn" data-format="csv">Export .csv</button>
        <button class="btn btn-theme theme-toggle">ðŸŒ“</button>
        <button class="btn btn-graph graph-toggle">Graph</button>
      </div>
      <canvas id="graph-canvas" class="graph-canvas"></canvas>
    </div>
    <div id="history-panel" class="history-panel">
      <h4>History</h4>
      <input type="text" class="history-search" placeholder="Filter historyâ€¦">
      <div class="history-content"></div>
    </div>
  </div>
<script>
  // Debounce helper
  const debounce = (fn, delay) => { let timer; return (...args) => { clearTimeout(timer); timer = setTimeout(() => fn(...args), delay); }; };
  
  // Auto theme based on hour
  const root = document.documentElement;
  (() => {
    const hr = new Date().getHours();
    root.setAttribute('data-theme', (hr >= 19 || hr < 6) ? 'dark' : 'light');
  })();
  
  // Manual theme toggle
  document.querySelector('.theme-toggle').addEventListener('click', () => {
    const currentTheme = root.getAttribute('data-theme');
    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
    root.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
  });
  
  class Calculator {
    constructor() {
      // Elements
      this.display = document.getElementById('display');
      this.resultEl = document.getElementById('result');
      this.buttonsContainer = document.querySelector('.buttons');
      this.historyPanel = document.getElementById('history-panel');
      this.historyContent = document.querySelector('.history-content');
      this.historySearch = document.querySelector('.history-search');
      this.canvas = document.getElementById('graph-canvas');
      this.ctx = this.canvas.getContext('2d');
      // State
      this.expr = '';
      this.justCalculated = false;
      this.lastResult = 0;
      this.memory = 0;
      this.history = JSON.parse(localStorage.getItem('calcHistory') || '[]');
      this.filteredHistory = [];
      this.saveHistory = debounce(h => localStorage.setItem('calcHistory', JSON.stringify(h)), 300);
      
      // Init
      this.initButtons();
      this.renderHistory();
    }
    
    initButtons() {
      const tokens = [
        'C', '(', ')', '/',
        '7', '8', '9', '*',
        '4', '5', '6', '-',
        '1', '2', '3', '+',
        '0', '.', '%', '=',
        'sin(', 'cos(', 'tan(', 'log10(',
        'sqrt(', 'abs(', '^', 'pi',
        'e', 'phi', 'gamma', 'ANS',
        'M+', 'M-', 'MR', 'MC',
        'Â°Câ†’Â°F', 'Â°Fâ†’Â°C', 'kmâ†’m', 'mâ†’km',
        'gâ†’kg', 'kgâ†’g'
      ];
      
      tokens.forEach(tok => {
        const btn = document.createElement('button');
        btn.className = 'btn';
        if (tok === 'C') btn.classList.add('btn-clear');
        if (tok === '=') btn.classList.add('btn-history'); // style equals button
        btn.textContent = tok;
        btn.addEventListener('click', () => { this.handleToken(tok); btn.blur(); });
        this.buttonsContainer.appendChild(btn);
      });
      
      // Copy icon
      document.querySelector('.copy-icon').addEventListener('click', () => {
        if (navigator.clipboard) {
          navigator.clipboard.writeText(this.resultEl.textContent).then(() => {
            alert('Result copied to clipboard!');
          });
        }
      });
      
      // History controls
      document.querySelector('.toggle-history').addEventListener('click', () => this.historyPanel.classList.toggle('show'));
      document.querySelector('.clear-history').addEventListener('click', () => this.clearHistory());
      document.querySelectorAll('.export-btn').forEach(b => b.addEventListener('click', e => this.exportHistory(e.target.dataset.format)));
      
      // Graph toggle
      document.querySelector('.graph-toggle').addEventListener('click', () => this.toggleGraph());
      
      // Filter history
      this.historySearch.addEventListener('input', e => this.filterHistory(e.target.value));
      
      // Keyboard support
      document.addEventListener('keydown', e => {
        if (document.activeElement === this.historySearch) return; // Don't interfere with history search
        e.preventDefault();
        if (/^[0-9.+\-*/^()%]$/.test(e.key)) this.handleToken(e.key);
        else if (e.key === 'Enter' || e.key === '=') this.handleToken('=');
        else if (e.key === 'Backspace') this.backspace();
        else if (e.key === 'Escape' || e.key.toLowerCase() === 'c') this.handleToken('C');
      });
    }
    
    handleToken(tok) {
      if (tok === 'C') return this.clearAll();
      if (tok === '=') return this.calculate();
      if (tok === 'ANS') return this.append(this.lastResult);
      if (tok === 'M+') { this.memory += this.lastResult; return; }
      if (tok === 'M-') { this.memory -= this.lastResult; return; }
      if (tok === 'MR') return this.append(this.memory);
      if (tok === 'MC') { this.memory = 0; return; }
      if (tok === 'phi') return this.append('phi');
      if (tok === 'gamma') return this.append('gamma');
      if (tok === 'Â°Câ†’Â°F') return this.convertTemp('CtoF');
      if (tok === 'Â°Fâ†’Â°C') return this.convertTemp('FtoC');
      if (tok === 'kmâ†’m' || tok === 'mâ†’km' || tok === 'gâ†’kg' || tok === 'kgâ†’g') {
        const conversions = {'kmâ†’m': 'kmToM', 'mâ†’km': 'mToKm', 'gâ†’kg': 'gToKg', 'kgâ†’g': 'kgToG'};
        return this.convertUnit(conversions[tok]);
      }
      
      // For all other tokens (numbers, operators, functions)
      this.append(tok);
    }
    
    append(char) {
      if (this.justCalculated && !/[+\-*/^%]/.test(char)) {
          this.expr = ''; // Start new expression if a number is pressed after '='
      }
      if (this.justCalculated && /[+\-*/^%]/.test(char)) {
          this.expr = this.lastResult.toString(); // Use last result in new calculation
      }
      this.justCalculated = false;
      this.expr += char;
      this.display.textContent = this.expr || '0';
    }
    
    calculate() {
      if (!this.expr) return;
      try {
        const res = math.evaluate(this.expr);
        this.showResult(res, `${this.expr} = ${res}`);
      } catch (err) {
        this.resultEl.textContent = err.message.includes('Parenthesis') ? 'Mismatched ()' : 'Syntax Error';
      }
    }
    
    showResult(res, histEntry) {
      const formattedRes = Number(res.toPrecision(15)); // Format to avoid floating point issues
      this.resultEl.textContent = formattedRes;
      this.lastResult = formattedRes;
      this.justCalculated = true;
      this.history.unshift(histEntry);
      if (this.history.length > 100) this.history.pop(); // Limit history size
      this.renderHistory();
      this.saveHistory(this.history);
    }
    
    backspace() {
      this.expr = this.expr.slice(0, -1);
      this.display.textContent = this.expr || '0';
      this.justCalculated = false;
    }
    
    clearAll() {
      this.expr = '';
      this.display.textContent = '0';
      this.resultEl.textContent = '0';
      this.justCalculated = false;
    }
    
    convertTemp(mode) {
      const val = (this.expr && !this.justCalculated) ? parseFloat(this.expr) : this.lastResult;
      if (isNaN(val)) return;
      let res;
      if (mode === 'CtoF') res = val * 9/5 + 32;
      else res = (val - 32) * 5/9;
      this.showResult(res, `${val}${mode === 'CtoF' ? 'Â°C' : 'Â°F'} â†’ ${res.toFixed(2)}${mode === 'CtoF' ? 'Â°F' : 'Â°C'}`);
    }
    
    convertUnit(unit) {
      const val = (this.expr && !this.justCalculated) ? parseFloat(this.expr) : this.lastResult;
      if (isNaN(val)) return;
      let res, label;
      switch (unit) {
        case 'kmToM': res = val * 1000; label = `km â†’ m`; break;
        case 'mToKm': res = val / 1000; label = `m â†’ km`; break;
        case 'gToKg': res = val / 1000; label = `g â†’ kg`; break;
        case 'kgToG': res = val * 1000; label = `kg â†’ g`; break;
      }
      this.showResult(res, `${val} ${label} = ${res}`);
    }
    
    toggleGraph() {
        if (this.canvas.style.display === 'block') {
            this.canvas.style.display = 'none';
            return;
        }
        this.canvas.style.display = 'block';
        const expr = prompt('Enter an expression for f(x):', this.expr.includes('x') ? this.expr : 'x^2');
        if (!expr) {
            this.canvas.style.display = 'none';
            return;
        }
        try {
            const f = math.compile(expr);
            const { width, height } = this.canvas;
            const xMin = -10, xMax = 10;
            const yMin = -10, yMax = 10;

            this.ctx.clearRect(0, 0, width, height);
            this.ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--fg').trim();
            this.ctx.lineWidth = 2;

            // Draw axes
            this.ctx.beginPath();
            this.ctx.moveTo(0, height / 2);
            this.ctx.lineTo(width, height / 2);
            this.ctx.moveTo(width / 2, 0);
            this.ctx.lineTo(width / 2, height);
            this.ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--panel-border').trim();
            this.ctx.stroke();
            this.ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--fg').trim();
            
            // Draw function
            this.ctx.beginPath();
            let firstPoint = true;
            for (let i = 0; i <= width; i++) {
                const x = xMin + (i / width) * (xMax - xMin);
                const y = f.evaluate({ x: x });
                if (isFinite(y)) {
                    const canvasX = i;
                    const canvasY = height - ((y - yMin) / (yMax - yMin)) * height;
                    if (firstPoint) {
                        this.ctx.moveTo(canvasX, canvasY);
                        firstPoint = false;
                    } else {
                        this.ctx.lineTo(canvasX, canvasY);
                    }
                }
            }
            this.ctx.stroke();
        } catch (err) {
            alert('Invalid function: ' + err.message);
            this.canvas.style.display = 'none';
        }
    }
    
    renderHistory() {
      this.filteredHistory = this.history;
      this._renderHistoryView();
    }
    
    filterHistory(query) {
      const term = query.toLowerCase();
      this.filteredHistory = this.history.filter(h => h.toLowerCase().includes(term));
      this._renderHistoryView();
    }
    
    _renderHistoryView() {
      if (this.filteredHistory.length > 0) {
        this.historyContent.innerHTML = this.filteredHistory.map(h => {
            const [expr] = h.split('=');
            return `<div class="history-entry" title="Click to use expression">${h}</div>`;
        }).join('');

        this.historyContent.querySelectorAll('.history-entry').forEach((entry, index) => {
            entry.addEventListener('click', () => {
                const [expr] = this.filteredHistory[index].split('=');
                this.expr = expr.trim();
                this.display.textContent = this.expr;
                this.justCalculated = false;
                this.historyPanel.classList.remove('show');
            });
        });

      } else {
          this.historyContent.innerHTML = '<p style="text-align: center; color: #888;">No history found.</p>';
      }
    }
    
    clearHistory() {
      if (confirm('Are you sure you want to clear all history?')) {
        this.history = [];
        this.renderHistory();
        this.saveHistory(this.history);
      }
    }
    
    exportHistory(fmt) {
      if (!this.history.length) { alert('History is empty.'); return; }
      const header = fmt === 'csv' ? 'Expression,Result\n' : '';
      const body = this.history.map(h => fmt === 'csv' ? h.replace(' = ', ',') : h).join('\n');
      const blob = new Blob([header + body], { type: fmt === 'csv' ? 'text/csv' : 'text/plain' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `calculator-history.${fmt}`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }
  }
  
  // Initialize the calculator once the window loads
  window.onload = () => {
    window.calc = new Calculator();
  };
</script>
</body>
</html>
